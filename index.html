<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Local Authenticator — Random Codes</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#6ee7b7;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#071023, #071827);padding:24px;display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:380px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  h1{font-size:18px;margin:0 0 8px 0}
  label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
  input[type=text], input[type=password], select {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8;font-size:14px}
  button{margin-top:10px;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#012;cursor:pointer;font-weight:600}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .row{display:flex;gap:8px;margin-top:10px}
  .code{font-family:monospace;font-size:36px;letter-spacing:6px;text-align:center;padding:12px 0}
  .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;transform-origin:left;transition:transform .2s linear;background:linear-gradient(90deg,#34d399,#06b6d4)}
  .small{font-size:12px;color:var(--muted)}
  .danger{background:#ef4444;color:#fff}
  .controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
  .tiny{font-size:12px;padding:8px 10px;border-radius:8px}
  .center{text-align:center}
</style>
</head>
<body>
  <div class="card" id="app">
    <h1>Local Authenticator — Random Codes</h1>

    <!-- REGISTER / LOGIN -->
    <div id="authView">
      <div id="registerBox">
        <label>Create an account (stored on this device)</label>
        <input id="regUser" type="text" placeholder="username" autocomplete="username">
        <input id="regPass" type="password" placeholder="password" autocomplete="new-password">
        <div class="row">
          <button id="doRegister">Create account</button>
          <button id="toLogin" class="tiny">Already have one?</button>
        </div>
        <div id="regMsg" class="muted small"></div>
      </div>

      <div id="loginBox" style="display:none">
        <label>Login</label>
        <input id="logUser" type="text" placeholder="username" autocomplete="username">
        <input id="logPass" type="password" placeholder="password" autocomplete="current-password">
        <div class="row">
          <button id="doLogin">Login</button>
          <button id="toRegister" class="tiny">Create account</button>
        </div>
        <div id="logMsg" class="muted small"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Logged in as <strong id="who"></strong></div>
          <div id="status" class="muted small">Generator stopped</div>
        </div>
        <div>
          <button id="logout" class="tiny">Logout</button>
        </div>
      </div>

      <div class="code center" id="code">------</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <div class="small">Interval:
          <select id="intervalSelect" style="display:inline-block;width:auto">
            <option value="5">5s</option>
            <option value="10">10s</option>
            <option value="15">15s</option>
            <option value="30">30s</option>
            <option value="60" selected>60s</option>
          </select>
        </div>
        <div class="small">Expires in <span id="expires">--</span></div>
      </div>

      <div style="margin-top:10px" class="progress"><div id="bar" class="bar"></div></div>

      <div class="controls">
        <button id="startBtn" class="tiny">Start</button>
        <button id="stopBtn" class="tiny" style="display:none">Stop</button>
        <button id="copyBtn" class="tiny">Copy</button>
        <button id="delAccount" class="tiny danger">Delete account</button>
      </div>

      <div id="appMsg" class="muted small" style="margin-top:8px"></div>
    </div>
    <div class="muted small" style="margin-top:12px">Security: passwords are hashed locally with PBKDF2 + salt. No data leaves your device.</div>
  </div>

<script>
/* -------------------------
  Helper: storage wrapper
   ------------------------- */
const DB_KEY = 'local_auth_randcodes_v1';
function saveDB(obj){ localStorage.setItem(DB_KEY, JSON.stringify(obj)); }
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY) || '{}'); } catch(e){ return {}; }}

/* -------------------------
  Crypto helpers (Web Crypto)
  - PBKDF2 for password hashing
  - generate secure random codes
  ------------------------- */
const enc = new TextEncoder();
const dec = new TextDecoder();

async function genSalt(len = 16){
  const b = new Uint8Array(len);
  crypto.getRandomValues(b);
  return btoa(String.fromCharCode(...b));
}

async function hashPassword(password, saltB64){
  const salt = Uint8Array.from(atob(saltB64), c => c.charCodeAt(0));
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveBits','deriveKey']);
  const derived = await crypto.subtle.deriveKey({
    name:'PBKDF2',
    salt,
    iterations: 200000,
    hash: 'SHA-256'
  }, keyMaterial, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
  const raw = await crypto.subtle.exportKey('raw', derived);
  return btoa(String.fromCharCode(...new Uint8Array(raw)));
}

function makeRandom6(){
  // generate a secure 6-digit number as string
  const arr = new Uint8Array(4);
  crypto.getRandomValues(arr);
  // convert to a 32-bit number
  const num = (arr[0]<<24) | (arr[1]<<16) | (arr[2]<<8) | arr[3];
  // JS bit ops produce signed numbers, take absolute and mod
  const positive = Math.abs(num) % 1000000;
  return String(positive).padStart(6,'0');
}

/* -------------------------
  UI elements
  ------------------------- */
const regUser = document.getElementById('regUser');
const regPass = document.getElementById('regPass');
const doRegister = document.getElementById('doRegister');
const regMsg = document.getElementById('regMsg');
const toLogin = document.getElementById('toLogin');

const loginBox = document.getElementById('loginBox');
const registerBox = document.getElementById('registerBox');
const toRegister = document.getElementById('toRegister');
const logUser = document.getElementById('logUser');
const logPass = document.getElementById('logPass');
const doLogin = document.getElementById('doLogin');
const logMsg = document.getElementById('logMsg');

const authView = document.getElementById('authView');
const appView = document.getElementById('appView');
const who = document.getElementById('who');
const status = document.getElementById('status');
const codeEl = document.getElementById('code');
const intervalSelect = document.getElementById('intervalSelect');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const copyBtn = document.getElementById('copyBtn');
const bar = document.getElementById('bar');
const expires = document.getElementById('expires');
const logout = document.getElementById('logout');
const delAccount = document.getElementById('delAccount');
const appMsg = document.getElementById('appMsg');

/* -------------------------
  App state
  ------------------------- */
let DB = loadDB(); // { users: {username: {salt, hash}}, current: username or null }
if (!DB.users) DB.users = {};
saveDB(DB);

let currentUser = null;
let running = false;
let intervalSec = parseInt(intervalSelect.value,10) || 60;
let currentCode = '------';
let cycleStart = Date.now(); // reference for progress
let tickTimer = null;

/* -------------------------
  UI: register / login flow
  ------------------------- */
toLogin.addEventListener('click', ()=>{ registerBox.style.display='none'; loginBox.style.display='block'; regMsg.textContent='';});
toRegister.addEventListener('click', ()=>{ loginBox.style.display='none'; registerBox.style.display='block'; logMsg.textContent='';});

doRegister.addEventListener('click', async ()=>{
  const u = regUser.value.trim();
  const p = regPass.value;
  regMsg.textContent='';
  if (!u || !p){ regMsg.textContent='Choose username and password.'; return; }
  if (DB.users[u]){ regMsg.textContent='That username already exists.'; return; }
  regMsg.textContent='Creating...';
  const salt = await genSalt();
  const hashed = await hashPassword(p, salt);
  DB.users[u] = { salt, hash: hashed, created: Date.now() };
  DB.current = u;
  saveDB(DB);
  regMsg.textContent='Account created. You are logged in.';
  setTimeout(()=> openApp(u),500);
});

doLogin.addEventListener('click', async ()=>{
  const u = logUser.value.trim();
  const p = logPass.value;
  logMsg.textContent='';
  if (!u || !p){ logMsg.textContent='Enter username and password.'; return; }
  const record = DB.users[u];
  if (!record){ logMsg.textContent='No such user.'; return; }
  logMsg.textContent='Checking...';
  const hashed = await hashPassword(p, record.salt);
  if (hashed === record.hash){
    DB.current = u; saveDB(DB);
    logMsg.textContent='Login successful.';
    openApp(u);
  } else {
    logMsg.textContent='Wrong password.';
  }
});

/* -------------------------
  App view functions
  ------------------------- */
function openApp(username){
  currentUser = username;
  who.textContent = username;
  authView.style.display='none';
  appView.style.display='block';
  status.textContent = 'Generator stopped';
  codeEl.textContent = '------';
  currentCode = '------';
  running = false;
  stopInternalTick();
}

logout.addEventListener('click', ()=>{
  DB.current = null; saveDB(DB);
  currentUser = null;
  authView.style.display='block';
  appView.style.display='none';
  regUser.value=''; regPass.value=''; logUser.value=''; logPass.value='';
});

delAccount.addEventListener('click', ()=>{
  if (!currentUser) return;
  if (!confirm('Delete account and all local data for "'+currentUser+'"? This cannot be undone.')) return;
  delete DB.users[currentUser];
  DB.current = null;
  saveDB(DB);
  currentUser = null;
  authView.style.display='block';
  appView.style.display='none';
});

/* -------------------------
  Generator control & UI tick
  ------------------------- */
intervalSelect.addEventListener('change', ()=>{
  intervalSec = parseInt(intervalSelect.value,10);
  // if running, restart cycle so code aligns
  if (running){
    cycleStart = Date.now();
    generateAndShow();
  } else {
    updateProgress();
  }
});

startBtn.addEventListener('click', ()=>{
  if (!currentUser){ appMsg.textContent='No user logged in.'; return; }
  running = true;
  cycleStart = Date.now();
  startBtn.style.display='none';
  stopBtn.style.display='inline-block';
  status.textContent = 'Generator running';
  generateAndShow();
  startInternalTick();
});

stopBtn.addEventListener('click', ()=>{
  running = false;
  stopBtn.style.display='none';
  startBtn.style.display='inline-block';
  status.textContent = 'Generator stopped';
  stopInternalTick();
});

copyBtn.addEventListener('click', async ()=>{
  try {
    await navigator.clipboard.writeText(currentCode);
    appMsg.textContent = 'Code copied!';
    setTimeout(()=> appMsg.textContent='',1000);
  } catch(e){
    appMsg.textContent = 'Copy failed. Select and copy manually.';
  }
});

/* internal tick: update progress frequently for smooth bar */
function startInternalTick(){
  if (tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(()=> {
    updateProgress();
    // recalc code when cycle finished
    const elapsed = (Date.now() - cycleStart) / 1000;
    if (elapsed >= intervalSec) {
      cycleStart = Date.now();
      generateAndShow();
    }
  }, 150);
}
function stopInternalTick(){ if (tickTimer) clearInterval(tickTimer); tickTimer = null; updateProgress(); }

/* create new code and show */
function generateAndShow(){
  currentCode = makeRandom6();
  codeEl.textContent = currentCode;
  updateProgress(true);
}

/* update progress bar and expiry text */
function updateProgress(forceNew){
  const now = Date.now();
  const elapsedMs = (now - cycleStart);
  let elapsed = elapsedMs / 1000;
  if (elapsed < 0) elapsed = 0;
  if (elapsed > intervalSec) elapsed = intervalSec;
  const remain = Math.ceil(Math.max(0, intervalSec - elapsed));
  const progress = Math.max(0, Math.min(1, 1 - (remain / intervalSec)));
  bar.style.transform = `scaleX(${progress})`;
  expires.textContent = remain + 's';
  // when stopped show hyphens
  if (!running && !forceNew){
    bar.style.transform = 'scaleX(0)';
    codeEl.textContent = '------';
    expires.textContent = '--';
  }
}

/* -------------------------
  If a user was already logged in, open the app automatically
  ------------------------- */
if (DB.current && DB.users[DB.current]){
  openApp(DB.current);
  // keep UI neat: show start button
}

/* -------------------------
  Extra: protect against brute-force lockout (client-side light)
  ------------------------- */
/* (Optional) You can implement attempt counters, but remember it's client-side only
   and only deters casual guessing on the local device. For brevity this is omitted.
*/

/* -------------------------
  End of script
  ------------------------- */
</script>
</body>
</html>
