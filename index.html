<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Local TOTP Authenticator</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#6ee7b7;--muted:#94a3b8}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef8;background:linear-gradient(180deg,#071023,#071827);padding:24px;display:flex;align-items:center;justify-content:center;min-height:100vh}
.card{width:380px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
h1{font-size:18px;margin:0 0 8px 0}
label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
input[type=text], input[type=password], select {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8;font-size:14px}
button{margin-top:10px;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#012;cursor:pointer;font-weight:600}
.muted{color:var(--muted);font-size:13px;margin-top:8px}
.row{display:flex;gap:8px;margin-top:10px}
.code{font-family:monospace;font-size:36px;letter-spacing:6px;text-align:center;padding:12px 0}
.progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
.bar{height:100%;width:0;transform-origin:left;transition:transform .1s linear;background:linear-gradient(90deg,#34d399,#06b6d4)}
.small{font-size:12px;color:var(--muted)}
.danger{background:#ef4444;color:#fff}
.controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
.tiny{font-size:12px;padding:8px 10px;border-radius:8px}
.center{text-align:center}
</style>
</head>
<body>
<div class="card" id="app">
<h1>Local TOTP Authenticator</h1>

<!-- REGISTER / LOGIN -->
<div id="authView">
<div id="registerBox">
<label>Create an account (stored locally)</label>
<input id="regUser" type="text" placeholder="username" autocomplete="username">
<input id="regPass" type="password" placeholder="password" autocomplete="new-password">
<div class="row">
<button id="doRegister">Create account</button>
<button id="toLogin" class="tiny">Already have one?</button>
</div>
<div id="regMsg" class="muted small"></div>
</div>

<div id="loginBox" style="display:none">
<label>Login</label>
<input id="logUser" type="text" placeholder="username" autocomplete="username">
<input id="logPass" type="password" placeholder="password" autocomplete="current-password">
<div class="row">
<button id="doLogin">Login</button>
<button id="toRegister" class="tiny">Create account</button>
</div>
<div id="logMsg" class="muted small"></div>
</div>
</div>

<!-- APP -->
<div id="appView" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div class="small">Logged in as <strong id="who"></strong></div>
<div id="status" class="muted small">Generator stopped</div>
</div>
<div>
<button id="logout" class="tiny">Logout</button>
</div>
</div>

<label>Enter TOTP secret key (from Roblox or any service)</label>
<input id="totpSecret" type="text" placeholder="Base32 Secret">

<div class="code center" id="code">------</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
<div class="small">Interval:
<select id="intervalSelect" style="display:inline-block;width:auto">
<option value="0.1">0.1s</option>
<option value="0.25">0.25s</option>
<option value="0.5">0.5s</option>
<option value="5">5s</option>
<option value="10">10s</option>
<option value="15">15s</option>
<option value="30">30s</option>
<option value="60" selected>60s</option>
</select>
</div>
<div class="small">Expires in <span id="expires">--</span></div>
</div>

<div class="progress"><div id="bar" class="bar"></div></div>

<div class="controls">
<button id="startBtn" class="tiny">Start</button>
<button id="stopBtn" class="tiny" style="display:none">Stop</button>
<button id="copyBtn" class="tiny">Copy</button>
<button id="delAccount" class="tiny danger">Delete account</button>
</div>

<div id="appMsg" class="muted small" style="margin-top:8px"></div>
<div class="muted small" style="margin-top:12px">Security: passwords are hashed locally. TOTP secret never leaves your device.</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
// ------------------ STORAGE ------------------
const DB_KEY='local_totp_auth_v1';
function saveDB(obj){localStorage.setItem(DB_KEY,JSON.stringify(obj))}
function loadDB(){try{return JSON.parse(localStorage.getItem(DB_KEY)||'{}')}catch(e){return{}}}
let DB=loadDB();if(!DB.users)DB.users={};saveDB(DB);

// ------------------ CRYPTO ------------------
const enc=new TextEncoder();
async function genSalt(len=16){const b=new Uint8Array(len);crypto.getRandomValues(b);return btoa(String.fromCharCode(...b))}
async function hashPassword(password,saltB64){const salt=Uint8Array.from(atob(saltB64),c=>c.charCodeAt(0));const keyMaterial=await crypto.subtle.importKey('raw',enc.encode(password),{name:'PBKDF2'},false,['deriveBits','deriveKey']);const derived=await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt','decrypt']);const raw=await crypto.subtle.exportKey('raw',derived);return btoa(String.fromCharCode(...new Uint8Array(raw)));}

// ------------------ TOTP ------------------
function base32toHex(base32){
    const base32chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let bits="";let hex="";base32=base32.replace(/=+$/,'').toUpperCase();
    for(let i=0;i<base32.length;i++){let val=base32chars.indexOf(base32.charAt(i));bits+=val.toString(2).padStart(5,'0')}
    for(let i=0;i+4<=bits.length;i+=4){hex+=parseInt(bits.substr(i,4),2).toString(16)}
    return hex;
}
function leftpad(str,len){return '0'.repeat(len-str.length)+str}
function getTOTP(secret,intervalSec=30){try{
    const key=base32toHex(secret);const epoch=Math.floor(Date.now()/1000);const time=Math.floor(epoch/intervalSec).toString(16).padStart(16,'0');
    const keyBytes=hexToBytes(key);const timeBytes=hexToBytes(time);
    const hmac=CryptoJS.HmacSHA1(bytesToHex(timeBytes),bytesToHex(keyBytes));const offset=parseInt(hmac.substring(hmac.length-1),16)*2;const code=parseInt(hmac.substr(offset,8),16)&0x7fffffff;return leftpad((code%1000000).toString(),6)
}catch(e){return '------'}}
function hexToBytes(hex){const bytes=new Uint8Array(hex.length/2);for(let i=0;i<hex.length;i+=2){bytes[i/2]=parseInt(hex.substr(i,2),16)}return bytes}
function bytesToHex(bytes){return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('')}

// ------------------ ELEMENTS ------------------
const regUser=document.getElementById('regUser'),regPass=document.getElementById('regPass'),doRegister=document.getElementById('doRegister'),regMsg=document.getElementById('regMsg'),toLogin=document.getElementById('toLogin');
const loginBox=document.getElementById('loginBox'),registerBox=document.getElementById('registerBox'),toRegister=document.getElementById('toRegister'),logUser=document.getElementById('logUser'),logPass=document.getElementById('logPass'),doLogin=document.getElementById('doLogin'),logMsg=document.getElementById('logMsg');
const authView=document.getElementById('authView'),appView=document.getElementById('appView'),who=document.getElementById('who');
const totpSecret=document.getElementById('totpSecret'),codeEl=document.getElementById('code'),intervalSelect=document.getElementById('intervalSelect'),expires=document.getElementById('expires'),bar=document.getElementById('bar');
const startBtn=document.getElementById('startBtn'),stopBtn=document.getElementById('stopBtn'),copyBtn=document.getElementById('copyBtn'),logoutBtn=document.getElementById('logout'),delAccount=document.getElementById('delAccount'),appMsg=document.getElementById('appMsg'),status=document.getElementById('status');

// ------------------ REGISTER / LOGIN ------------------
toLogin.onclick=()=>{registerBox.style.display='none';loginBox.style.display='block'}
toRegister.onclick=()=>{loginBox.style.display='none';registerBox.style.display='block'}

doRegister.onclick=async()=>{
    const u=regUser.value.trim(),p=regPass.value.trim()
    if(!u||!p){regMsg.textContent='Fill both fields';return;}
    if(DB.users[u]){regMsg.textContent='Username exists';return;}
    const salt=await genSalt(),hash=await hashPassword(p,salt)
    DB.users[u]={salt,hash,totp:''};saveDB(DB);regMsg.textContent='Account created!';regUser.value='';regPass.value=''
}

doLogin.onclick = async () => {
    const u = logUser.value.trim();
    const p = logPass.value.trim();
    if (!u || !p) { logMsg.textContent = 'Fill both fields'; return; }
    if (!DB.users[u]) { logMsg.textContent = 'User not found'; return; }
    const { salt, hash } = DB.users[u];
    try {
        const check = await hashPassword(p, salt);
        if (check !== hash) { logMsg.textContent = 'Wrong password'; return; }
        logUser.value = ''; logPass.value = ''; logMsg.textContent = '';
        login(u);
    } catch (e) { logMsg.textContent = 'Error logging in'; console.error(e); }
}

function login(username){
    who.textContent=username;authView.style.display='none';appView.style.display='block';
    totpSecret.value=DB.users[username].totp||'';updateStatus('Stopped')
}

// ------------------ TOTP & INTERVAL ------------------
let running=false,intervalSec=parseFloat(intervalSelect.value);
intervalSelect.addEventListener('change', ()=>{
    let newInterval=parseFloat(intervalSelect.value);
    if(newInterval<1){
        const confirmFast=confirm(`You selected ${newInterval}s interval.\nAre you sure you want to continue?`);
        if(!confirmFast){intervalSelect.value=intervalSec; return;}
    }
    intervalSec=newInterval;
})

function updateStatus(txt){status.textContent=txt}
function generateCode(){
    const secret=totpSecret.value.trim();if(!secret){codeEl.textContent='------';return;}
    const val=getTOTP(secret,intervalSec);codeEl.textContent=val
}

let timer;
function startGen(){
    if(!totpSecret.value.trim()){appMsg.textContent='Enter secret key';return;}
    running=true;updateStatus('Running');startBtn.style.display='none';stopBtn.style.display='inline-block';cycle()
}
function stopGen(){running=false;updateStatus('Stopped');startBtn.style.display='inline-block';stopBtn.style.display='none';expires.textContent='--';bar.style.transform='scaleX(0)'}

function cycle(){
    if(!running)return;
    generateCode()
    const start=Date.now();const duration=intervalSec*1000;
    function step(){
        if(!running)return;
        const now=Date.now();const pct=Math.min(1,(now-start)/duration);
        bar.style.transform=`scaleX(${pct})`;expires.textContent=(intervalSec-(now-start)/1000).toFixed(1)+'s';
        if(pct>=1){generateCode();cycle()}else requestAnimationFrame(step);
    }requestAnimationFrame(step);
}

// ------------------ BUTTONS ------------------
startBtn.onclick=startGen
stopBtn.onclick=stopGen
copyBtn.onclick=()=>{navigator.clipboard.writeText(codeEl.textContent);appMsg.textContent='Copied!';setTimeout(()=>appMsg.textContent='',1500)}
logoutBtn.onclick=()=>{authView.style.display='block';appView.style.display='none';updateStatus('Stopped');running=false}
delAccount.onclick=()=>{
    if(confirm('Are you sure you want to delete your account?')){
        delete DB.users[who.textContent];saveDB(DB);authView.style.display='block';appView.style.display='none'
    }
}

// ------------------ LIBRARY ------------------
!function(a,b){var c={};c.HmacSHA1=function(a,b){return CryptoJS.HmacSHA1(a,b).toString(CryptoJS.enc.Hex)};window.CryptoJS=c}(window);
</script>
</body>
